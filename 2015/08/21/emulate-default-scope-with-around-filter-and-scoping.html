<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js'>
<!-- <![endif] -->
<head></head>
<meta charset='utf-8'>
<meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
<meta content='Blake Tidwell, professional web developer and aspiring EDM producer, talks bytes, beats, and philosophy.' name='description'>
<meta content='width=device-width' name='viewport'>
<meta content='summary' name='twitter:card'>
<meta content='@BATidwell' name='twitter:site'>
<meta content='Emulate Default Scope with Around Filter and Scoping' name='twitter:title'>
<meta content='Blake Tidwell, professional web developer and aspiring EDM producer, talks bytes, beats, and philosophy.' name='twitter:description'>
<meta content='http://www.gravatar.com/avatar/b761c938fc4158ea4eed9f8283ac9fc3.png' name='twitter:image'>
<meta content='http://www.blaketidwell.com/2015/08/21/emulate-default-scope-with-around-filter-and-scoping.html' name='twitter:url'>
<title>
Blake Tidwell - Emulate Default Scope with Around Filter and Scoping
</title>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/stylesheets/app.css" rel="stylesheet" type="text/css" />
<link href='/favicon.ico?v=3' rel='shortcut icon'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
</html>
<body>
<!--[if lt IE 7]>
<p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
<![endif]-->
<div id='fb-root'></div>
<div class='row' id='header'>
<div class='small-12 columns'>
<div class='row'>
<div class='small-9 columns'>
<h1>
<a href="/">Blake Tidwell</a>
</h1>
<h2>Code. Create. Connect.</h2>
</div>
<div class='small-3 columns'>
<img class='avatar show-for-medium-up' src='http://www.gravatar.com/avatar/b761c938fc4158ea4eed9f8283ac9fc3.png'>
</div>
</div>
<div class='row'>
<div class='small-12 medium-offset-9 medium-3 columns'>
<ul class='social inline-list'>
<li>
<a href='http://www.linkedin.com/in/blaketidwell'>
<i class='fi-social-linkedin'></i>
</a>
</li>
<li>
<a href='https://github.com/blaketidwell'>
<i class='fi-social-github'></i>
</a>
</li>
<li>
<a href='https://twitter.com/BATidwell'>
<i class='fi-social-twitter'></i>
</a>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class='row' id='container'>
<div class='small-12 medium-8 columns' id='main' role='main'>
<article>
<h1 class='article-title'>Emulate Default Scope with Around Filter and Scoping</h1>
<div class='row share-container'>
<div class='small-12 columns'>
<div class='share'>
<a class='twitter-share-button' data-count='none' data-hashtags='codecreateconnect' data-related='BATidwell' href='https://twitter.com/share'>
Tweet
</a>
<div class='fb-like' data-action='like' data-layout='button' data-share='true'></div>
</div>
</div>
</div>
<p>We all know that <a href="http://rails-bestpractices.com/posts/2013/06/15/default_scope-is-evil/"><code>default_scope</code> is
evil</a>.
But sometimes, you really <em>do</em> want to make sure that a condition is <em>almost</em>
always applied to the queries for a particular model. Draft vs. published posts,
approved vs. unapproved content, soft deletes, cat videos vs. not-cat videos,
etc., etc.  What&rsquo;s a well-behaved Rails developer to do?  Recently, I
encountered this exact issue on a project I was working on, and was not
satisfied with the choice between Being Evil &agrave; la <code>default_scope</code> or
being repetitive and scattering <code>where(whatever: true)</code> conditions throughout
the code.  After some searching, I came across a combination of methods that
accomplishes essentially the same goal without all of the bizarre side effects
of <code>default_scope</code>.</p>

<p></p>

<h2>Le Hypothetical Situation</h2>

<p>Imagine that we want to build a blogging platform in Rails with the usual
draft-before-publish workflow. Basically, we want to make sure that drafts only
ever show up when an admin is logged in. The first solution that comes to mind
for a problem like this is to chuck the condition into a <code>default_scope</code> on your
model:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="n">where</span><span class="p">(</span><span class="ss">draft: </span><span class="kp">false</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>I won&rsquo;t rehash the challenges of using <code>default_scope</code> in this post; give the
Rails Best Practices link at the top of this post a good read and you should at
least get the general idea that there are a lot of weird things to account for
with this approach.</p>

<h2>Le Alternative Different</h2>

<p>Enter <code>after_filter</code> and <code>scoping</code>. Below is a simple example of using this
approach in the <code>ApplicationController</code> to accomplish the same draft filtering:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span>

  <span class="n">around_filter</span> <span class="ss">:scope_to_published</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">scope_to_published</span>
    <span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">draft: </span><span class="kp">false</span><span class="p">).</span><span class="nf">scoping</span> <span class="k">do</span>
      <span class="k">yield</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This results in the <code>Post</code> model being &ldquo;globally&rdquo; scoped before running the rest
of the controller method. Since it happens in the <code>ApplicationController</code>, it
will apply to all subclassed controllers. (Worth noting is that <code>where(draft:
false)</code> can of course be converted to an equivalent scope named <code>published</code> or
some such.) Using this approach, and some thoughtful placement in the controller
hieararchy, it is possible to increase or decrease the granularity of a
&ldquo;default&rdquo; condition. It is easy to imagine having an <code>AdminController</code> that does
not inherit from <code>ApplicationController</code> and would therefore not be subject to
this global scoping. Alternatively, a <code>skip_filter</code> directive could be added
only to those controllers where this scoping should not apply. In the direction
of more specificity, the <code>around_filter</code> could be moved further down the class
hierarchy and explicitly applied to the <code>PostsController</code> or any number of
related controllers.</p>

<h1>Un Caveat</h1>

<p>As a disclaimer, I have not benchmarked the effect this might have at the
<code>ApplicationController</code> level. I would guess that in the best case, it should
incur no more performance overhead than an explicit <code>where</code> clause, and in
the worst case, it would incur a trivial impact more than made up for by
conciseness. Can&rsquo;t say for certain without running benchmarks, but I invite any
interested readers to share any findings or insights they might have in this
regard.</p>

<div class='row'>
<div class='small-12 columns'>
<div class='share'>
<a class='twitter-share-button' data-count='none' data-hashtags='codecreateconnect' data-related='BATidwell' href='https://twitter.com/share'>
Tweet
</a>
<div class='fb-like' data-action='like' data-layout='button' data-share='true'></div>
</div>
</div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_title = 'Emulate Default Scope with Around Filter and Scoping'
                                var disqus_shortname = 'blaketidwell';
                  
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
//<![CDATA[
    var disqus_shortname = 'blaketidwell';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script>

</article>

</div>
<aside class='medium-4 columns show-for-medium-up' id='filters'>
<h3>Recent Articles</h3>
<ul>
<li>
<a href="/2015/08/21/emulate-default-scope-with-around-filter-and-scoping.html">Emulate Default Scope with Around Filter and Scoping</a>
<span>Aug&nbsp;21</span>
</li>
<li>
<a href="/2015/08/16/keeping-your-app-from-flying-off-of-the-rails-with-bdd-part-1.html">Keeping Your App from Flying Off of the Rails with BDD - Part 1 of Question Mark</a>
<span>Aug&nbsp;16</span>
</li>
<li>
<a href="/2015/03/04/drinking-the-koolixir-part-2-epers-creepers-the-erlang-toolkit.html">Drinking The Koolixir (Part 2) - EPERs Creepers, The Erlang Toolkit!</a>
<span>Mar&nbsp; 4</span>
</li>
<li>
<a href="/2015/02/07/drinking-the-koolixir.html">Drinking The Koolixir (Part 1)</a>
<span>Feb&nbsp; 7</span>
</li>
<li>
<a href="/2015/01/27/ember-rails-csrf-handling.html">Ember Rails CSRF Handling</a>
<span>Jan&nbsp;27</span>
</li>
<li>
<a href="/2014/11/24/leds-and-303s-static-page-on-divshot.html">LEDs and 303s Static Page on Divshot</a>
<span>Nov&nbsp;24</span>
</li>
<li>
<a href="/2014/03/23/starting-from-the-middleman.html">Starting From the Middle(Man)</a>
<span>Mar&nbsp;23</span>
</li>
</ul>
<h3>Tags</h3>
<ul>
<li><a href="/tags/technical.html">technical (7)</a></li>
<li><a href="/tags/ruby.html">ruby (5)</a></li>
<li><a href="/tags/blog.html">blog (1)</a></li>
<li><a href="/tags/how-to.html">how-to (3)</a></li>
<li><a href="/tags/deployment.html">deployment (1)</a></li>
<li><a href="/tags/emberjs.html">emberjs (1)</a></li>
<li><a href="/tags/rails.html">rails (3)</a></li>
<li><a href="/tags/quickread.html">quickread (2)</a></li>
<li><a href="/tags/dragons.html">dragons (1)</a></li>
<li><a href="/tags/functional.html">functional (2)</a></li>
<li><a href="/tags/languages.html">languages (2)</a></li>
<li><a href="/tags/erlang.html">erlang (2)</a></li>
<li><a href="/tags/elixir.html">elixir (2)</a></li>
<li><a href="/tags/cash-cats.html">cash cats (1)</a></li>
</ul>
<h3>By Year</h3>
<ul>
<li><a href="/2015.html">2015 (5)</a></li>
<li><a href="/2014.html">2014 (2)</a></li>
</ul>
</aside>
</div>
<div id='footer'>
<div class='row'>
<div class='small-12 medium-4 columns'>
<h3>Recent Articles</h3>
<ul>
<li>
<a href="/2015/08/21/emulate-default-scope-with-around-filter-and-scoping.html">Emulate Default Scope with Around Filter and Scoping</a>
<span>Aug&nbsp;21</span>
</li>
<li>
<a href="/2015/08/16/keeping-your-app-from-flying-off-of-the-rails-with-bdd-part-1.html">Keeping Your App from Flying Off of the Rails with BDD - Part 1 of Question Mark</a>
<span>Aug&nbsp;16</span>
</li>
<li>
<a href="/2015/03/04/drinking-the-koolixir-part-2-epers-creepers-the-erlang-toolkit.html">Drinking The Koolixir (Part 2) - EPERs Creepers, The Erlang Toolkit!</a>
<span>Mar&nbsp; 4</span>
</li>
<li>
<a href="/2015/02/07/drinking-the-koolixir.html">Drinking The Koolixir (Part 1)</a>
<span>Feb&nbsp; 7</span>
</li>
<li>
<a href="/2015/01/27/ember-rails-csrf-handling.html">Ember Rails CSRF Handling</a>
<span>Jan&nbsp;27</span>
</li>
<li>
<a href="/2014/11/24/leds-and-303s-static-page-on-divshot.html">LEDs and 303s Static Page on Divshot</a>
<span>Nov&nbsp;24</span>
</li>
<li>
<a href="/2014/03/23/starting-from-the-middleman.html">Starting From the Middle(Man)</a>
<span>Mar&nbsp;23</span>
</li>
</ul>
</div>
<div class='small-12 medium-4 columns'>
<h3>Tags</h3>
<div class='row'>
<div class='small-12 medium-6 columns'>
<ul class='tag-group'>
<li><a href="/tags/technical.html">technical (7)</a></li>
<li><a href="/tags/ruby.html">ruby (5)</a></li>
<li><a href="/tags/blog.html">blog (1)</a></li>
<li><a href="/tags/how-to.html">how-to (3)</a></li>
<li><a href="/tags/deployment.html">deployment (1)</a></li>
<li><a href="/tags/emberjs.html">emberjs (1)</a></li>
<li><a href="/tags/rails.html">rails (3)</a></li>
</ul>
</div>
<div class='small-12 medium-6 columns'>
<ul class='tag-group last'>
<li><a href="/tags/quickread.html">quickread (2)</a></li>
<li><a href="/tags/dragons.html">dragons (1)</a></li>
<li><a href="/tags/functional.html">functional (2)</a></li>
<li><a href="/tags/languages.html">languages (2)</a></li>
<li><a href="/tags/erlang.html">erlang (2)</a></li>
<li><a href="/tags/elixir.html">elixir (2)</a></li>
<li><a href="/tags/cash-cats.html">cash cats (1)</a></li>
</ul>
</div>
</div>
</div>
<div class='small-12 medium-4 columns'>
<h3>By Year</h3>
<ul>
<li><a href="/2015.html">2015 (5)</a></li>
<li><a href="/2014.html">2014 (2)</a></li>
</ul>
</div>
</div>
</div>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-22797683-1', 'blaketidwell.com');
  ga('send', 'pageview');
</script>
</body>
